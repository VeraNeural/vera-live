// =============================================================================
// VERA KNOWLEDGE BASE
// The integrated wisdom of neurobiology, nervous system science, psychoanalysis,
// psychology, and psychiatry — as one coherent understanding.
// 
// Built by VERANeural from neuroscience, out of necessity and love.
// =============================================================================

// -----------------------------------------------------------------------------
// NERVOUS SYSTEM
// -----------------------------------------------------------------------------
export const NERVOUS_SYSTEM = `
THE NERVOUS SYSTEM — FOUNDATION OF EVERYTHING

The Autonomic Nervous System Has Three States:

VENTRAL VAGAL (Safe & Social)
- The regulated state — calm, connected, curious, creative
- Capable of intimacy, play, complex thinking, and presence
- Heart rate is steady, breath is deep, muscles are relaxed
- This is where healing, growth, and real connection happen
- Signs: Eye contact feels natural, voice is melodic, face is expressive

SYMPATHETIC (Fight or Flight)
- Activated state — the body perceives threat and mobilizes
- Anxiety, restlessness, racing thoughts, irritability
- Heart pounds, breath shortens, muscles tense
- Good for real danger, exhausting when chronic
- Signs: Fidgeting, difficulty sitting still, snapping at people, hypervigilance

DORSAL VAGAL (Freeze/Shutdown)
- Collapsed state — the body has given up, conserving energy
- Numbness, dissociation, hopelessness, "not really here"
- Feels heavy, slow, disconnected from body and world
- An ancient survival response — playing dead
- Signs: Flat voice, vacant eyes, difficulty moving or deciding, isolation

Key Principles:
- State determines capacity. You cannot think clearly when dysregulated.
- State is not choice. People do not choose to be anxious or shut down.
- State is contagious. A regulated presence helps others regulate.
- Safety is biological. The nervous system scans for danger 24/7 (neuroception).
- Co-regulation precedes self-regulation. We learn to calm ourselves through others first.

What Shifts State:
- Breath (slow exhale activates ventral vagal)
- Movement (completes the stress cycle)
- Connection (safe presence, eye contact, warm voice)
- Orientation (looking around, noticing the present environment)
- Touch (when safe and welcome)
`;

// -----------------------------------------------------------------------------
// PATTERNS & ADAPTATIONS
// -----------------------------------------------------------------------------
export const PATTERNS = `
ADAPTIVE PATTERNS — WHY WE DO WHAT WE DO

The Core Truth:
Every pattern was once a solution. The body learned it to survive something real.
Patterns persist because they are familiar, not because they work.
Understanding this removes shame and opens the door to change.

HOW PATTERNS FORM

1. Something happened (often in childhood, but not always)
2. The nervous system learned a response that helped survive it
3. That response became automatic — a default setting
4. Now it runs even when the original threat is gone
5. The person feels "broken" but they are actually adapted

COMMON ADAPTIVE PATTERNS

People-Pleasing
- Learned when: Authenticity was punished, needs were burdensome, love was conditional
- The logic: "If I make everyone happy, I will be safe/loved"
- The cost: Loss of self, resentment, exhaustion, relationships built on performance
- The shift: Learning that real connection requires real self

Avoidance
- Learned when: Engagement was overwhelming, trying led to failure or pain
- The logic: "If I do not try, I cannot fail/get hurt"
- The cost: Life gets smaller, potential stays unlived, anxiety grows
- The shift: Building tolerance for discomfort in small doses

Perfectionism
- Learned when: "Good enough" was not safe, mistakes were punished
- The logic: "If I am perfect, I cannot be criticized/rejected"
- The cost: Paralysis, procrastination, never feeling satisfied, burnout
- The shift: Learning that imperfect action beats perfect inaction

Control
- Learned when: Chaos was the norm, unpredictability meant danger
- The logic: "If I control everything, nothing bad will happen"
- The cost: Exhaustion, anxiety when plans change, pushing people away
- The shift: Building tolerance for uncertainty, learning to trust

Self-Sabotage
- Learned when: Success brought danger, envy, abandonment, or more pressure
- The logic: "If I fail, I stay safe/connected/humble"
- The cost: Never reaching potential, confusion about why you keep undermining yourself
- The shift: Examining what success means and what it threatens

Hyperindependence
- Learned when: Depending on others led to disappointment or pain
- The logic: "If I need no one, no one can let me down"
- The cost: Loneliness, exhaustion, inability to receive, shallow relationships
- The shift: Learning that needing people is human, not weak

BREAKING PATTERNS

1. See it — without judgment, with curiosity
2. Name it — "This is my [pattern]. It makes sense that I learned this."
3. Understand it — What was it protecting? What did it solve?
4. Feel the cost — What is it costing you now?
5. Find current safety — What does safety actually look like now?
6. Practice new — Small experiments, with support, expecting discomfort
7. Repeat — The body learns through repetition, not insight alone
`;

// -----------------------------------------------------------------------------
// EMOTIONAL STATES
// -----------------------------------------------------------------------------
export const STATES = `
EMOTIONAL STATES — WHAT THEY ARE AND WHAT THEY NEED

Emotions are information. They are not problems to fix.
They live in the body, not just the mind.
The goal is not to eliminate them but to understand and move through them.

ANXIETY

What it is:
- Mobilization for a threat that may not exist (or may not be happening now)
- Future-focused: "What if..." thinking on repeat
- The sympathetic nervous system is activated

Where it lives:
- Chest (tightness, racing heart)
- Breath (shallow, fast, held)
- Mind (spinning, catastrophizing)
- Body (restless, fidgety, cannot settle)

What it needs:
- Grounding in the present moment
- Slow exhales (longer out than in)
- Orienting to safety (what is actually happening right now?)
- Movement to discharge the energy
- Not reassurance loops — they feed anxiety

ANGER

What it is:
- Energy for protection, boundary-setting, or action
- Often a protective layer over hurt, fear, helplessness, or grief
- Not bad — it is information and fuel

Where it lives:
- Jaw (clenched)
- Fists and arms (tension, wanting to push or hit)
- Heat (face, chest)
- Voice (wanting to yell)

What it needs:
- Acknowledgment — it is allowed to exist
- Safe expression — physical movement, not destruction
- Curiosity — what is underneath? What boundary was crossed?
- Sometimes action — anger can fuel necessary change

SHAME

What it is:
- The belief "I am bad" (not "I did bad")
- The most isolating emotion — thrives in secrecy
- Often installed by others, long ago

Where it lives:
- Gut (sick feeling)
- Posture (collapsed, making self small)
- Eyes (cannot look, wants to hide)
- Face (heat, blushing)

What it needs:
- Connection — shame heals in relationship, not alone
- Being seen without judgment
- Separating behavior from identity
- Understanding where it came from

GRIEF

What it is:
- The natural response to loss (of a person, a dream, an identity, a possibility)
- Not a problem to solve — a process to move through
- Has no timeline

Where it lives:
- Throat (lump, difficulty speaking)
- Chest (heaviness, ache)
- Whole body (waves, weight)

What it needs:
- Permission to exist
- Presence, not fixing
- Space and time
- Witnessing — not alone

NUMBNESS / DISSOCIATION

What it is:
- The body's circuit breaker when overwhelmed
- Dorsal vagal shutdown — protective, not laziness
- Can feel like: emptiness, watching yourself from outside, "not really here"

Where it lives:
- Whole body (heaviness or absence of sensation)
- Eyes (glazed, unfocused)
- Time (feeling unreal, gaps)

What it needs:
- Safety first — do not force re-engagement
- Gentle sensory input (cold water, strong taste, texture)
- Slow return — it left for a reason
- Compassion — this is protection, not failure

LONELINESS

What it is:
- The ache of disconnection — from others or from self
- Can exist in a crowded room
- A signal that something essential is missing

What it needs:
- Acknowledgment (not "just go be social")
- Understanding the quality of connection needed
- Small genuine moments over forced socializing
- Sometimes, reconnection to self first
`;

// -----------------------------------------------------------------------------
// BODY-MIND CONNECTION
// -----------------------------------------------------------------------------
export const BODY_MIND = `
THE BODY-MIND CONNECTION

The Body Remembers What the Mind Forgets:
- Trauma, stress, and chronic patterns are stored in the body
- Tension patterns hold old experiences
- The body responds before the mind understands why
- "The issues are in the tissues"

READING THE BODY

Breath:
- Shallow/fast = sympathetic activation (fight/flight)
- Held = bracing for impact, trying to control
- Deep and slow = ventral vagal (safety)
- Sighing = body trying to regulate itself

Shoulders:
- Raised = vigilance, carrying weight
- Rounded forward = protection, withdrawal
- Dropped and back = openness, safety

Jaw:
- Clenched = anger, control, holding back words
- Soft = safety, nothing to brace against

Chest:
- Tight = anxiety, grief, protection
- Open = safety, connection

Gut:
- Tight/nauseous = anxiety, shame, dread
- Butterflies = excitement or fear (same physiology)
- Hollow = grief, emptiness

Hands:
- Fisted = anger, readiness to fight
- Gripping = control, anxiety
- Open = receptivity, calm

WORKING WITH THE BODY

Principles:
- Awareness often shifts the pattern without force
- Small movements are often more powerful than big ones
- The body needs to complete interrupted stress responses
- Rest is not laziness — it is repair
- Do not force, do not override, do not perform

Simple Practices:
- Orienting: Slowly look around the room, name what you see
- Grounding: Feel feet on floor, back against chair
- Breath: Extend the exhale (in for 4, out for 6-8)
- Shake: Literally shake hands, arms, whole body — animals do this to discharge stress
- Cold: Cold water on face or wrists activates the dive reflex, slows heart
- Movement: Walk, stretch, dance — let the body move the energy through
`;

// -----------------------------------------------------------------------------
// RELATIONSHIPS & ATTACHMENT
// -----------------------------------------------------------------------------
export const RELATIONSHIPS = `
RELATIONSHIPS & ATTACHMENT

How Early Relationships Shape Us:
- We learn what love looks like from our earliest caregivers
- These patterns become our "attachment style" — our default in relationships
- They are not destiny, but they are strong defaults
- Understanding them helps us choose differently

ATTACHMENT PATTERNS

Secure
- Learned: Caregivers were consistent, responsive, safe
- In relationships: Comfortable with intimacy and independence
- Can ask for needs, tolerate conflict, repair after rupture
- Not perfect — but flexible

Anxious (Preoccupied)
- Learned: Caregivers were inconsistent — sometimes there, sometimes not
- In relationships: Fear of abandonment, need for reassurance, hypervigilant to distance
- May become clingy, jealous, or overwhelming
- Core fear: "I will be left"

Avoidant (Dismissive)
- Learned: Caregivers were unavailable, or closeness was unsafe
- In relationships: Discomfort with intimacy, values independence highly
- May seem cold, distant, or shut down when partners need closeness
- Core fear: "I will be engulfed/lose myself"

Disorganized (Fearful-Avoidant)
- Learned: Caregivers were source of both comfort and fear
- In relationships: Wants closeness but fears it, push-pull pattern
- May be chaotic, unpredictable, or recreate trauma dynamics
- Core fear: Both abandonment AND engulfment

RELATIONSHIP PRINCIPLES

- We often choose what is familiar, not what is healthy
- Chemistry is often pattern recognition, not compatibility
- Conflict is not the problem — rupture without repair is
- Secure attachment can be earned at any age through healing relationships
- The goal is not to never get triggered — it is to recover faster

REPAIR

What makes relationships last is not avoiding conflict — it is repairing after it.

Good repair:
- Take responsibility for your part (without taking all blame)
- Acknowledge the other person's experience
- Do not defend, explain, or justify
- Ask what they need
- Do something different next time

Rupture without repair:
- Erodes trust over time
- Creates walking-on-eggshells dynamics
- Leads to contempt, the relationship killer
`;

// -----------------------------------------------------------------------------
// TRAUMA BASICS
// -----------------------------------------------------------------------------
export const TRAUMA = `
TRAUMA — WHAT IT IS AND IS NOT

Trauma is Not:
- Only big events (war, assault, disaster)
- Weakness or failure to cope
- Something to "get over"
- Always remembered clearly

Trauma Is:
- Any experience that overwhelms the nervous system's capacity to cope
- Stored in the body, not just the mind
- Often relational (betrayal, neglect, attachment wounds)
- Sometimes cumulative (many small wounds over time)

Big T vs Little t:
- Big T: Life-threatening events, violence, disaster
- Little t: Chronic invalidation, emotional neglect, bullying, loss
- Both can have profound effects
- Little t trauma is often dismissed but deeply impactful

How Trauma Lives in the Body:
- The stress response never completed
- The body stays braced for danger that already passed
- Triggers bring the past into the present
- Symptoms are the body trying to protect or process

Trauma Responses:
- Fight: Anger, control, aggression
- Flight: Anxiety, avoidance, running
- Freeze: Paralysis, dissociation, shutdown
- Fawn: People-pleasing, losing self to stay safe

Healing Principles:
- Safety first, always
- Slowly, with support — not alone
- The body must be involved, not just the mind
- It is not about remembering — it is about releasing
- Healing is not linear
- Post-traumatic growth is real
`;

// -----------------------------------------------------------------------------
// PRACTICAL INTEGRATION
// -----------------------------------------------------------------------------
export const INTEGRATION = `
PRACTICAL INTEGRATION — HOW VERA APPLIES THIS

1. STATE FIRST
   Before anything, read the state.
   Is this person regulated? Activated? Collapsed?
   Do not try to solve a thinking problem when it is a state problem.

2. VALIDATION WITHOUT AMPLIFICATION
   Acknowledge what is happening without making it bigger.
   "That makes sense" beats "That must be so hard for you."

3. CURIOSITY OVER DIAGNOSIS
   Wonder with them, not about them.
   "I'm curious about..." beats "What you're experiencing is..."

4. PATTERNS OVER PATHOLOGY
   See adaptive intelligence, not brokenness.
   "Your system learned..." not "You have a problem with..."

5. BODY AS ALLY
   Include the body naturally, not as a technique.
   "Where do you feel that?" "What does your body want to do?"

6. SMALL MOVES
   Big insights rarely change anything alone.
   Small experiments, repeated, change patterns.

7. AGENCY ALWAYS
   Never tell people what to do.
   Offer, suggest, invite, wonder. Leave choice intact.

8. WHEN IN DOUBT, SLOW DOWN
   If unsure, do less, not more.
   Presence is more powerful than intervention.
`;

// -----------------------------------------------------------------------------
// TOPIC EXTRACTION
// -----------------------------------------------------------------------------
export function extractTopics(text: string): string[] {
  const lowered = text.toLowerCase();
  const topics: string[] = [];
  
  // Nervous system / regulation
  if (/\b(anxi|stress|overwhelm|panic|nervous|calm|relax|breath|tension|tight|racing|cant stop|can't stop|wired|exhausted|activated|triggered|dysregulated)\b/.test(lowered)) {
    topics.push('nervous_system');
  }
  
  // Patterns / stuck / loops
  if (/\b(pattern|repeat|always|again|stuck|loop|habit|keep doing|same thing|why do i|every time|cycle|people.?pleas|perfecti|avoid|procrastinat|control|self.?sabotag|hyper.?independen)\b/.test(lowered)) {
    topics.push('patterns');
  }
  
  // Emotional states
  if (/\b(feel|feeling|emotion|angry|mad|furious|rage|pissed|irritat|shame|embarrass|humiliat|worthless|hate myself|sad|grief|loss|miss|mourn|cry|tears|numb|empty|nothing|dissociat|disconnected|lonely|alone|isolated|scared|fear|dread|worried|worry)\b/.test(lowered)) {
    topics.push('states');
  }
  
  // Body / somatic
  if (/\b(body|tension|breath|physical|chest|stomach|gut|heart|shoulders|jaw|hands|shaking|trembl|tight|heavy|cant breathe|can't breathe)\b/.test(lowered)) {
    topics.push('body_mind');
  }
  
  // Relationships
  if (/\b(relationship|partner|husband|wife|boyfriend|girlfriend|dating|marriage|divorce|breakup|ex |attachment|trust|abandon|cheat|betray|conflict|fight|fighting|boundary|boundaries|love|loved)\b/.test(lowered)) {
    topics.push('relationships');
  }
  
  // Trauma
  if (/\b(trauma|ptsd|abuse|assault|violence|flashback|trigger|nightmare|childhood|neglect|wound|hurt me|damaged)\b/.test(lowered)) {
    topics.push('trauma');
  }
  
  return [...new Set(topics)]; // Remove duplicates
}

// -----------------------------------------------------------------------------
// KNOWLEDGE RETRIEVAL
// -----------------------------------------------------------------------------
export function getRelevantKnowledge(topics: string[]): string {
  if (topics.length === 0) return '';
  
  const knowledge: string[] = [];
  
  if (topics.includes('nervous_system')) {
    knowledge.push(NERVOUS_SYSTEM);
  }
  
  if (topics.includes('patterns')) {
    knowledge.push(PATTERNS);
  }
  
  if (topics.includes('states')) {
    knowledge.push(STATES);
  }
  
  if (topics.includes('body_mind')) {
    knowledge.push(BODY_MIND);
  }
  
  if (topics.includes('relationships')) {
    knowledge.push(RELATIONSHIPS);
  }
  
  if (topics.includes('trauma')) {
    knowledge.push(TRAUMA);
  }
  
  // Always add integration principles when any knowledge is added
  if (knowledge.length > 0) {
    knowledge.push(INTEGRATION);
  }
  
  // Limit to 2 topic modules + integration to prevent prompt bloat
  const limited = knowledge.length > 3 
    ? [...knowledge.slice(0, 2), INTEGRATION]
    : knowledge;
  
  return limited.length > 0 
    ? '\n\n--- VERA KNOWLEDGE (draw from naturally, do not quote or lecture) ---\n\n' + limited.join('\n\n---\n\n')
    : '';
}
