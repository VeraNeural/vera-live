# VERA Penetration Testing Environment Setup
# Run this script to prepare an isolated testing environment

param(
    [switch]$DryRun = $false,
    [string]$Environment = "staging"
)

Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
Write-Host "â•‘     VERA Penetration Testing Environment Setup               â•‘" -ForegroundColor Cyan
Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""

if ($DryRun) {
    Write-Host "[DRY RUN MODE - No changes will be made]" -ForegroundColor Yellow
    Write-Host ""
}

# Configuration
$TestAccounts = @(
    @{ Email = "pentest_free@test.vera.ai"; Role = "free"; Name = "Pentest Free User" },
    @{ Email = "pentest_paid@test.vera.ai"; Role = "paid"; Name = "Pentest Paid User" },
    @{ Email = "pentest_sanctuary@test.vera.ai"; Role = "sanctuary"; Name = "Pentest Sanctuary User" },
    @{ Email = "pentest_pro@test.vera.ai"; Role = "professional"; Name = "Pentest Professional" },
    @{ Email = "pentest_admin@test.vera.ai"; Role = "admin"; Name = "Pentest Admin" }
)

# Step 1: Verify Environment
Write-Host "Step 1: Verifying environment..." -ForegroundColor Green
Write-Host "  Target environment: $Environment"

$requiredEnvVars = @(
    "NEXT_PUBLIC_SUPABASE_URL",
    "NEXT_PUBLIC_SUPABASE_ANON_KEY",
    "SUPABASE_SERVICE_ROLE_KEY",
    "CLERK_SECRET_KEY"
)

$missingVars = @()
foreach ($var in $requiredEnvVars) {
    if (-not [Environment]::GetEnvironmentVariable($var)) {
        $missingVars += $var
    }
}

if ($missingVars.Count -gt 0) {
    Write-Host "  âš  Missing environment variables:" -ForegroundColor Yellow
    foreach ($var in $missingVars) {
        Write-Host "    - $var" -ForegroundColor Yellow
    }
    Write-Host "  Configure these before running in live mode." -ForegroundColor Yellow
} else {
    Write-Host "  âœ“ All required environment variables present" -ForegroundColor Green
}
Write-Host ""

# Step 2: Database Preparation
Write-Host "Step 2: Database preparation..." -ForegroundColor Green

$seedDataSQL = @"
-- Penetration Testing Seed Data
-- Run this against the test/staging database

-- Create test users (after Clerk account creation)
-- These placeholder records will be updated with real Clerk IDs

-- Seed test conversations for testing
INSERT INTO conversations (id, user_id, title, created_at)
VALUES 
  ('pentest-conv-001', 'CLERK_USER_ID_FREE', 'Test Conversation 1', NOW()),
  ('pentest-conv-002', 'CLERK_USER_ID_PAID', 'Test Conversation 2', NOW())
ON CONFLICT (id) DO NOTHING;

-- Seed test messages for testing
INSERT INTO messages (id, conversation_id, role, content, created_at)
VALUES
  ('pentest-msg-001', 'pentest-conv-001', 'user', 'This is a test message for penetration testing', NOW()),
  ('pentest-msg-002', 'pentest-conv-001', 'assistant', 'This is a test response', NOW())
ON CONFLICT (id) DO NOTHING;

-- Seed test memories (for memory feature testing)
INSERT INTO memories (id, user_id, content, category, created_at)
VALUES
  ('pentest-mem-001', 'CLERK_USER_ID_PAID', 'Test memory content', 'general', NOW())
ON CONFLICT (id) DO NOTHING;

-- Note: Update CLERK_USER_ID_* placeholders with actual IDs after account creation
"@

Write-Host "  SQL seed data prepared:"
Write-Host "  $($seedDataSQL.Split("`n").Count) lines of seed data"
if (-not $DryRun) {
    Write-Host "  âš  Manual execution required - save to file and run via Supabase" -ForegroundColor Yellow
    $seedDataSQL | Out-File -FilePath ".\pentest-seed-data.sql" -Encoding UTF8
    Write-Host "  âœ“ Saved to pentest-seed-data.sql" -ForegroundColor Green
}
Write-Host ""

# Step 3: Test Account Creation Instructions
Write-Host "Step 3: Test account creation..." -ForegroundColor Green
Write-Host "  Create the following accounts in Clerk Dashboard:" -ForegroundColor Yellow
Write-Host ""
foreach ($account in $TestAccounts) {
    Write-Host "  ğŸ“§ $($account.Email)" -ForegroundColor White
    Write-Host "     Role: $($account.Role)" -ForegroundColor Gray
    Write-Host "     Name: $($account.Name)" -ForegroundColor Gray
    Write-Host ""
}
Write-Host "  After creation:" -ForegroundColor Yellow
Write-Host "  1. Record Clerk user IDs"
Write-Host "  2. Update seed SQL with real IDs"
Write-Host "  3. Run seed SQL against database"
Write-Host "  4. Configure entitlements per role"
Write-Host ""

# Step 4: Stripe Test Mode Verification
Write-Host "Step 4: Stripe configuration..." -ForegroundColor Green
Write-Host "  Ensure Stripe is in TEST MODE" -ForegroundColor Yellow
Write-Host "  Test card numbers:"
Write-Host "    4242424242424242 - Successful payment"
Write-Host "    4000000000000002 - Card declined"
Write-Host "    4000000000009995 - Insufficient funds"
Write-Host ""

# Step 5: Enhanced Logging
Write-Host "Step 5: Enhanced logging configuration..." -ForegroundColor Green

$loggingConfig = @"
// Add to src/lib/audit.ts during pentest period

const PENTEST_MODE = process.env.PENTEST_MODE === 'true';

export function auditLog(action: string, details: Record<string, unknown>) {
  const logEntry = {
    timestamp: new Date().toISOString(),
    action,
    ...details,
    pentest_mode: PENTEST_MODE
  };
  
  if (PENTEST_MODE) {
    // Enhanced logging during pentest
    console.log('[PENTEST AUDIT]', JSON.stringify(logEntry, null, 2));
  }
  
  // Normal audit logging...
}
"@

Write-Host "  Enhanced logging configuration:"
Write-Host "  Set PENTEST_MODE=true in environment"
Write-Host "  This enables verbose audit logging during testing"
Write-Host ""

# Step 6: IP Allowlisting
Write-Host "Step 6: IP allowlisting (if applicable)..." -ForegroundColor Green
Write-Host "  If using IP-based restrictions:"
Write-Host "  1. Get tester's source IP addresses"
Write-Host "  2. Add to Vercel/WAF allowlist"
Write-Host "  3. Document in engagement records"
Write-Host ""

# Step 7: Monitoring Adjustments
Write-Host "Step 7: Monitoring adjustments..." -ForegroundColor Green
Write-Host "  During testing period:"
Write-Host "  â€¢ Adjust alerting thresholds to avoid false alarms"
Write-Host "  â€¢ Tag test traffic for filtering"
Write-Host "  â€¢ Enable extended log retention"
Write-Host "  â€¢ Assign on-call engineer"
Write-Host ""

# Step 8: Pre-test Verification
Write-Host "Step 8: Pre-test verification checklist..." -ForegroundColor Green
$checklist = @(
    "Test accounts created in Clerk",
    "Test accounts have correct entitlements",
    "Seed data loaded into test database",
    "Stripe in test mode",
    "PENTEST_MODE environment variable set",
    "Tester IP addresses documented",
    "Alerting thresholds adjusted",
    "On-call engineer assigned",
    "Scope document signed",
    "NDA executed",
    "Emergency contacts confirmed"
)

foreach ($item in $checklist) {
    Write-Host "  [ ] $item" -ForegroundColor White
}
Write-Host ""

# Summary
Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
Write-Host "â•‘     Setup Summary                                            â•‘" -ForegroundColor Cyan
Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""
Write-Host "  Manual Steps Required:" -ForegroundColor Yellow
Write-Host "  1. Create test accounts in Clerk Dashboard"
Write-Host "  2. Run seed SQL against test database"
Write-Host "  3. Configure Stripe test mode"
Write-Host "  4. Set PENTEST_MODE=true in environment"
Write-Host "  5. Complete verification checklist"
Write-Host ""
Write-Host "  Credentials Storage:" -ForegroundColor Yellow
Write-Host "  Store test account credentials in secure vault"
Write-Host "  Share with testers via secure channel only"
Write-Host ""

if ($DryRun) {
    Write-Host "[DRY RUN COMPLETE - Review output and run without -DryRun to execute]" -ForegroundColor Yellow
} else {
    Write-Host "Setup script complete. Follow manual steps above." -ForegroundColor Green
}
